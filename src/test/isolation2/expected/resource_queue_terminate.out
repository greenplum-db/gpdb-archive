-- Test various scenarios with respect to backend termination.

0:CREATE RESOURCE QUEUE rq_terminate WITH (active_statements = 1);
CREATE QUEUE
0:CREATE ROLE role_terminate RESOURCE QUEUE rq_terminate;
CREATE ROLE

--
-- Scenario 1: Terminate a backend with a regular open cursor
--
1:SET ROLE role_terminate;
SET
1:BEGIN;
BEGIN
1:DECLARE cs1 CURSOR FOR SELECT 0;
DECLARE CURSOR

0:SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE query='DECLARE cs1 CURSOR FOR SELECT 0;';
 pg_terminate_backend 
----------------------
 t                    
(1 row)

1<:  <... completed>
FAILED:  Execution failed
-- Sanity check: Ensure that the resource queue is now empty.
0:SELECT rsqcountlimit, rsqcountvalue FROM pg_resqueue_status WHERE rsqname = 'rq_terminate';
 rsqcountlimit | rsqcountvalue 
---------------+---------------
 1             | 0             
(1 row)

--
-- Scenario 2: Terminate a backend with a holdable open cursor that has been
-- persisted.
--
2:SET ROLE role_terminate;
SET
2:DECLARE cs2 CURSOR WITH HOLD FOR SELECT 0;
DECLARE CURSOR

0:SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE query='DECLARE cs2 CURSOR WITH HOLD FOR SELECT 0;';
 pg_terminate_backend 
----------------------
 t                    
(1 row)

2<:  <... completed>
FAILED:  Execution failed
-- Sanity check: Ensure that the resource queue is now empty.
0:SELECT rsqcountlimit, rsqcountvalue FROM pg_resqueue_status WHERE rsqname = 'rq_terminate';
 rsqcountlimit | rsqcountvalue 
---------------+---------------
 1             | 0             
(1 row)

--
-- Scenario 3: Terminate a backend with a waiting statement
--
3:SET ROLE role_terminate;
SET
3:BEGIN;
BEGIN
3:DECLARE cs3 CURSOR FOR SELECT 0;
DECLARE CURSOR
4:SET ROLE role_terminate;
SET
4&:SELECT 331763;  <waiting ...>

0:SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE query='SELECT 331763;';
 pg_terminate_backend 
----------------------
 t                    
(1 row)

4<:  <... completed>
FATAL:  terminating connection due to administrator command
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.
3:END;
COMMIT
-- Sanity check: Ensure that the resource queue is now empty.
0:SELECT rsqcountlimit, rsqcountvalue FROM pg_resqueue_status WHERE rsqname = 'rq_terminate';
 rsqcountlimit | rsqcountvalue 
---------------+---------------
 1             | 0             
(1 row)

--
-- Scenario 4: Terminate a backend with a waiting holdable cursor
--
5:SET ROLE role_terminate;
SET
5:BEGIN;
BEGIN
5:DECLARE cs4 CURSOR FOR SELECT 0;
DECLARE CURSOR
6:SET ROLE role_terminate;
SET
6&:DECLARE cs5 CURSOR WITH HOLD FOR SELECT 0;  <waiting ...>

0:SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE query='DECLARE cs5 CURSOR WITH HOLD FOR SELECT 0;';
 pg_terminate_backend 
----------------------
 t                    
(1 row)

6<:  <... completed>
FATAL:  terminating connection due to administrator command
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.
5:END;
COMMIT
-- Sanity check: Ensure that the resource queue is now empty.
0:SELECT rsqcountlimit, rsqcountvalue FROM pg_resqueue_status WHERE rsqname = 'rq_terminate';
 rsqcountlimit | rsqcountvalue 
---------------+---------------
 1             | 0             
(1 row)


-- Cleanup
0:DROP ROLE role_terminate;
DROP ROLE
0:DROP RESOURCE QUEUE rq_terminate;
DROP QUEUE
